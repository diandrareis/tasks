<script>
    // --- Configura√ß√£o do Supabase (Mantida) ---
    const SUPABASE_URL = 'https://uwngmtgcxatmhsyplddk.supabase.co'; 
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV3bmdtdGdjeGF0bWhzeXBsZGRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1NzM3MjMsImV4cCI6MjA3NjE0OTcyM30.kJU3l9QTbJUTjX6kUBuorox9qAfmw6pasN5yRNj7C24'; 
    const TABLE_NAME = 'daily_tasks';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- Vari√°veis e Seletores (Mantidos) ---
    const numTasksInput = document.getElementById('numTasks');
    const taskDateInput = document.getElementById('taskDate');
    const scheduledTasksList = document.getElementById('scheduledTasksList');
    let scheduledTasks = {};

    // ----------------------------------------------------------------------
    // üí° FUN√á√ïES ESSENCIAIS QUE DEVEM PERMANECER GLOBAIS (Chamadas pelo HTML)
    // ----------------------------------------------------------------------

    /**
     * Fun√ß√£o global para salvar a contagem (chamada pelo <button onclick="saveCount()">).
     */
    async function saveCount() {
        const selectedDate = taskDateInput.value;
        const numTasks = parseInt(numTasksInput.value);

        if (isNaN(numTasks) || numTasks < 1) {
            alert('Por favor, insira um n√∫mero v√°lido de tarefas (m√≠nimo 1).');
            return;
        }
        
        // As fun√ß√µes internas s√£o chamadas do escopo interno
        const success = await saveTaskCountToDB(selectedDate, numTasks);

        if (success) {
            scheduledTasks[selectedDate] = numTasks;
            displayAllScheduledTasks();
            alert(`Contagem de ${numTasks} tarefas para ${formatDisplayDate(selectedDate)} salva com sucesso no banco de dados!`);
        }
    }

    /**
     * Fun√ß√£o global para remover uma tarefa (chamada pelos bot√µes "√ó" din√¢micos).
     */
    async function deleteTaskCount(date) {
        if (!confirm(`Tem certeza que deseja remover o agendamento para ${formatDisplayDate(date)}?`)) {
            return;
        }
        
        const { error } = await supabase
            .from(TABLE_NAME)
            .delete()
            .eq('date', date);

        if (error) {
            console.error('Erro ao remover do Supabase:', error);
            alert('Erro ao remover dados. Verifique o console.');
            return;
        }

        delete scheduledTasks[date];
        displayAllScheduledTasks();
        alert(`Agendamento para ${formatDisplayDate(date)} removido com sucesso!`);
        
        if (taskDateInput.value === date) {
            numTasksInput.value = 1;
            checkTaskAlert();
        }
    }


    // ----------------------------------------------------------------------
    // üí° ESCOPO INTERNO (Fun√ß√µes internas n√£o globais)
    // ----------------------------------------------------------------------

    (function() {
        // --- Fun√ß√µes de Banco de Dados ---

        async function loadTasks() {
            const { data, error } = await supabase
                .from(TABLE_NAME)
                .select('date, task_count');

            if (error) {
                console.error('Erro ao carregar tarefas do Supabase:', error);
                // N√£o alertamos aqui, pois a p√°gina deve carregar mesmo com erro de leitura.
                return;
            }

            scheduledTasks = data.reduce((acc, row) => {
                acc[row.date] = row.task_count;
                return acc;
            }, {});
        }

        async function saveTaskCountToDB(date, count) {
            const { error } = await supabase
                .from(TABLE_NAME)
                .upsert({ date: date, task_count: count }, { onConflict: 'date' }); 

            if (error) {
                console.error('Erro ao salvar no Supabase:', error);
                alert('Erro ao salvar dados. Verifique o console.');
                return false;
            }
            return true;
        }

        // --- Fun√ß√µes de Formato e Alerta ---
        
        function formatDisplayDate(isoDate) {
            if (!isoDate) return '';
            const parts = isoDate.split('-');
            return `${parts[2]}/${parts[1]}/${parts[0]}`;
        }

        function checkTaskAlert() {
            const numTasks = parseInt(numTasksInput.value);
            numTasksInput.classList.remove('alert-yellow', 'alert-red');

            if (numTasks >= 20) {
                numTasksInput.classList.add('alert-red');
            } else if (numTasks > 15) {
                numTasksInput.classList.add('alert-yellow');
            }
        }
        
        function getAlertClass(count) {
            if (count >= 20) {
                return 'summary-red';
            } else if (count > 15) {
                return 'summary-yellow';
            } else if (count > 0) {
                return 'summary-green';
            }
            return '';
        }

        // --- Fun√ß√µes de Exibi√ß√£o ---

        function displayAllScheduledTasks() {
            scheduledTasksList.innerHTML = '';
            
            const dates = Object.keys(scheduledTasks).sort();
            
            if (dates.length === 0) {
                scheduledTasksList.innerHTML = '<p style="text-align: center; color: #777;">Nenhum dia agendado ainda.</p>';
                return;
            }

            dates.forEach(date => {
                const count = scheduledTasks[date];
                if (count > 0) {
                    const alertClass = getAlertClass(count);
                    const displayDate = formatDisplayDate(date);
                    
                    const item = document.createElement('div');
                    item.className = `summary-item ${alertClass}`;
                    // Note que 'deleteTaskCount' √© chamado globalmente
                    item.innerHTML = `
                        <span class="date">${displayDate}</span>
                        <span class="count">${count} Tasks</span>
                        <button class="delete-btn" onclick="deleteTaskCount('${date}')" title="Remover Agendamento">
                            &times;
                        </button>
                    `;
                    scheduledTasksList.appendChild(item);
                }
            });
        }

        // --- Inicializa√ß√£o e Eventos ---
        
        window.onload = async function() { 
            await loadTasks();
            
            const initialDate = new Date().toISOString().split('T')[0];
            taskDateInput.value = initialDate;
            
            if (scheduledTasks[initialDate]) {
                numTasksInput.value = scheduledTasks[initialDate];
            } else {
                numTasksInput.value = 1; 
            }
            
            checkTaskAlert(); 
            displayAllScheduledTasks();
        };
        
        taskDateInput.addEventListener('change', function() {
            const selectedDate = taskDateInput.value;
            
            const savedCount = scheduledTasks[selectedDate] || 1; 
            numTasksInput.value = savedCount;
            
            checkTaskAlert();
        });

        // Torna as fun√ß√µes internas necess√°rias acess√≠veis √†s fun√ß√µes globais
        // Esta √© uma solu√ß√£o alternativa para garantir que as fun√ß√µes globais possam chamar as fun√ß√µes internas
        window.saveTaskCountToDB = saveTaskCountToDB;
        window.formatDisplayDate = formatDisplayDate;
        window.displayAllScheduledTasks = displayAllScheduledTasks;
        window.checkTaskAlert = checkTaskAlert;

    })(); // Fim do IIFE

    // Note: As fun√ß√µes globais saveCount() e deleteTaskCount() ainda dependem 
    // das fun√ß√µes internas, mas agora o resto do c√≥digo est√° isolado.

</script>
